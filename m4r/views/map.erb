<script type="text/javascript" charset="utf-8">
var proxy_host = "<%= PLATFORM_API_URL %>";    
var project_attributes = ["project t0", "project i0", "activity count", "financing", "sector1", "approval 0"];
var worldbank_sectors = ["agriculture","communication","energy","education","finance","health","industry","public","transportation","water"];

var sector_icons =  {"EP":"<%= PLATFORM_API_URL %>/wbimages/icons/education-on.png","AZ":"<%= PLATFORM_API_URL %>/wbimages/icons/agriculture-on.png","JB":"<%= PLATFORM_API_URL %>/wbimages/icons/health-on.png","BC":"<%= PLATFORM_API_URL %>/wbimages/icons/public-on.png","TA":"<%= PLATFORM_API_URL %>/wbimages/icons/transportation-on.png","LE":"<%= PLATFORM_API_URL %>/wbimages/icons/energy-on.png","TZ":"<%= PLATFORM_API_URL %>/wbimages/icons/transportation-on.png","LD":"<%= PLATFORM_API_URL %>/wbimages/icons/energy-on.png","WZ":"<%= PLATFORM_API_URL %>/wbimages/icons/water-on.png","BL":"<%= PLATFORM_API_URL %>/wbimages/icons/public-on.png","BU":"<%= PLATFORM_API_URL %>/wbimages/icons/public-on.png","AB":"<%= PLATFORM_API_URL %>/wbimages/icons/agriculture-on.png","FD":"<%= PLATFORM_API_URL %>/wbimages/icons/finance-on.png","ET":"<%= PLATFORM_API_URL %>/wbimages/icons/education"};

var project_sectors = {"General agriculture":"agriculture", "Agricultural extension and research":"agriculture", "fishing and forestry sector":"agriculture", 
  "Central government administration":"public","Public administration- Energy and mining": "public", "Public administration- Agriculture, fishing and forestry": "public", 
  "Primary education":"education", "Tertiary education": "education",
  "Other social services":"health",
  "Water supply":"water",
  "General transportation sector":"transportation","Roads and highways":"transportation", 
  "Renewable energy":"energy",  "Power": "energy", 
  "Non-compulsory pensions, insurance and contractual savings":"finance",
  "Default":"public"};

// , "General agriculture, fishing and forestry sector":"agriculture"
if(typeof(F1)=='undefined') {F1 = {}}
(function(){
  Object.size = function(obj) {
      var size = 0, key;
      for (key in obj) {
          if (obj.hasOwnProperty(key)) size++;
      }
      return size;
  };

  Object.include = function(arr, obj) {
    for(var i=0; i<arr.length; i++) {
      if (arr[i] == obj) return i;
    }
    return null;
  }

  String.prototype.capitalize = function(){
    return this.replace( /(^|\s)([a-z])/g , function(m,p1,p2){ return p1+p2.toUpperCase(); } );
  };  
  
  F1.WorldBank = function(options) {  //constructor
    this.options = options;
    // F1.WorldBank.instances[options.id] = this;
  }

  F1.WorldBank.indicators = {
		"Extreme Poverty": {source: "finder:", title:"Poverty", subtitle: "1998 Headcount Index", styles: { type: "CHOROPLETH",fill: { colors: [0xFEF7A5, 0xFECE6D, 0xEC8414, 0xAE4C02, 0x662506], categories: 5, classificationType: "St Dev", opacity: 0.55, selectedAttribute: "Height_for" }}},
		"Malnutrition": {source: "finder:", title:"Child Malnutrition", subtitle: "Percentile weight of Children under 5 (DHS 1998)", styles: { type: "CHOROPLETH", fill: { colors: [0x4A342C, 0x7C6253, 0xA4866D, 0xD1B79F, 0xEBD9C2], categories: 5, classificationType: "EQUAL INTERVAL", opacity: 0.75, selectedAttribute: "Weight_for" }}},
		"Infant Mortality": {source: "finder:", title:"Infant Mortality Rate", subtitle: "Per 1,000 live births (DHS 1998)", styles: { type: "CHOROPLETH", fill: { colors: [0xFEE5D9, 0xFCAE91, 0xFB6A4A, 0xDE2D26, 0xA50F15], categories: 5, classificationType: "EQUAL INTERVAL", opacity: 0.75, selectedAttribute: "Infant_mor"}}},
    "Maternal Health": {source: "finder:", title:"Births attended by skilled health staff ", subtitle: "% of Total (DHS 1998)", styles: { type: "CHOROPLETH",fill: { colors: [0x511483, 0x835BA4, 0xC090BD, 0xE3BBC2, 0xFCE3D7], categories: 5, classificationType: "EQUAL INTERVAL", opacity: 0.75, selectedAttribute: "Total_Skil"}}},
    "Population": {source: "finder:", title:"Population", subtitle: "", styles: { type: "CHOROPLETH",fill: { colors: [0xEFF3FF, 0xBDD7E7, 0x6BAED6, 0x3182BD, 0x08519C], categories: 5, classificationType: "EQUAL INTERVAL", opacity: 0.75, selectedAttribute: "pop"}}}
	},
  F1.WorldBank.prototype = {
    init: function(map_id) {
      
      var self = this;
      this.activities = {};
      this.projects = {};
      this.sectors = {};
      this.total_funding = 0;
      this.stylelayers = {};
      this.initialized = false;
      for(var i=0;i< worldbank_sectors.length;i++) {
        this.sectors[worldbank_sectors[i]] = {funding: 0, projects: [], activities: 0, sector: worldbank_sectors[i]};
      }

      
      this.map = new F1.Maker.Map( { dom_id:"geoiq_map",map_id:map_id, 
                uiZoom: true,uiLayers: false,uiLegend: true,uiStyles: true,
                uiHeader: true,hideGCLogo: true,hideGILogo: true,
                ShowControl:("Legend",true,"open"),
                core_host:  proxy_host + '/', finder_host:proxy_host + '/', maker_host: proxy_host + '/',
                onload: function() {  <%= @country[:projects].nil? ? "" : "drawCharts(wb, #{(@country[:projects])});" %> }
      });

    },
    setBookmark: function(key, value) {
      
    },
    setState: function(location,indicator,project,sectors) {
      if(location != null)
        setLocation("",location.lat,location.lon,location.zoom);
      this.setIndicator(indicator);
      if(sectors != null){
        var sector;
        for(sector in sectors)
          this.toggleSector(sectors[sector]);
      } else {
        this.toggleSector('all', false)
      }
    },
    setLocation: function(region,lat,lon,zoom) {
      this.setBookmark('region', region);
      this.map.setCenterZoom(lat,lon,zoom);
    },
    toggleSector: function(sector,visible) {
      var self = this;
      console.log("toggle: " + sector);
      if(visible == null)
        visible = "true";
      if(sector == 'all') {
        self.map.showLayer(self.stylelayers["Project Locations"].order, visible);
      }
      //self.sectorPieChart(sector);
    },
    setIndicator: function(indicator,visible) {
      var self = this;
      if(indicator == null) {
        $('#indicator').html("IndicatorS");
        self.map.showLayer(self.stylelayers["Indicators"].order, "false");
      }
      else {
        $('#indicator').html(indicator);
        self.map.showLayer(self.stylelayers["Indicators"].order, "true");
        self.map.setLayerStyle(self.stylelayers["Indicators"].order, F1.WorldBank.indicators[indicator].styles);
      }
    },

    sortData: function(data) {
      var self = this;
      self.activities = jq.map(data.features, function(feature) { 
        if (feature) {
          attr = feature.attributes;
          if(self.projects[attr["project i0"]] == null) { // first time we've seen this project ID
            var project = {};

            // Get the project level attributes
            for(var i = 0;i<project_attributes.length;i++) {
              if(project_attributes[i] != "activity count")
                project[project_attributes[i]] = attr[project_attributes[i]];
            }
            project["total amt0"] = attr["total amt0"];
            project["financing"] = "$" + attr["total amt0"] + " million";
            project["activity count"] = 0;
            self.projects[attr["project i0"]] = project
            
            // Add to sector funding and project count
            var sector = project["sector1"];
            var wb_sector = project_sectors[sector];

            if(wb_sector == null)
              wb_sector = project_sectors["Default"];
              
            self.sectors[wb_sector].funding += attr["total amt0"];
            self.sectors[wb_sector].projects.push(project);
            self.total_funding += self.sectors[wb_sector].funding;
          }
          self.projects[attr["project i0"]]["activity count"] += 1;
          
          var wb_sector = project_sectors[self.projects[attr["project i0"]]["sector1"]];
          if(wb_sector == null)
            wb_sector = project_sectors["Default"];

          self.sectors[wb_sector].activities += 1;
          return attr;
        }
      });      
    },
    projectTable: function(data) {
      $('#project_count').html(Object.size(this.projects));
      $('#activity_count').html(this.activities.length);
      data.attributes["activity count"] = {original_name: "activity county", name: "Activities"}
      data.attributes["financing"] = {original_name: "financing", name: "Financing"}
      data.features = this.projects;

      F1.Visualizer.charts.grid(500, 930, data, "projects-table", project_attributes);
    },
    sectorPieChart: function(sector_name) {
      var self = this;
      //console.log(self.sectors[sector_name].projects);
      $('#sector_funding_title').html("Project Funding for " + sector_name.capitalize() + " Projects")
      $('#sector_funding_total').html(self.sectors[sector_name].funding + " Million");
      pie_options = {"features":self.sectors[sector_name].projects, 
          "attributes": {"data":{"name": "Funding","original_name": "total amt0"},
          "description":{"name": "Project","original_name": "project i0"}, 
          "sort":{"name": "Funding","original_name": "total amt0"} } };
      F1.Visualizer.charts.pie(180, 455, pie_options, "chart-left-pie-chart");
    },
    sectorFundingBars: function() {
      var self = this;
      var s;
      var features = [];
      for(s in self.sectors) { features.push(self.sectors[s]); }
      // //console.log(features)
      $('#funding_total').html(self.total_funding + " Million");
      bar_options = {"features":features, "attributes": {
            "data":{"name": "Funding", "original_name": "funding"}, 
            "description":{"name": "Sector", "original_name": "sector"}, 
            "sort":{"name": "Activities","original_name": "activities"} } };
      F1.Visualizer.charts.bar(180, 455, bar_options, "chart-right-graph");
    },
    getLayers: function(map) {
      var self = this;
      var findlayers = ["Project Locations", "Indicators", "Population"];
      var possibleLayers = map.getLayers();
      var j;
      var index;
      for(j in possibleLayers) {
        index = Object.include(findlayers, possibleLayers[j].title);
        if(index != null){
          self.stylelayers[findlayers[index]] = {order: possibleLayers[j].order, source: possibleLayers[j].source};
        }
       }
       $('#download_data').attr('href','<%= PLATFORM_API_URL %>/overlays/' + self.stylelayers["Project Locations"].source.replace("finder:","")  + ".csv")
       return false;
    },
    styleMap: function(map) {
      var self = this;
      self.map.swf.addLayerCategoryFilter(self.stylelayers["Project Locations"].order, {attribute:"sector1code",categories:sector_icons});
    },
    drawCharts: function(map, projects_id) {
      var self = this;
      if( self.initialized ) {return;}
        
      self.getLayers(map);
      self.styleMap(map);
      F1.Visualizer.utils.get_data_from_flash(projects_id, function(data) {
          console.log("loaded");
          self.sortData(data);
          self.projectTable(data);
          self.sectorPieChart("public");        
          self.sectorFundingBars();
          self.initialized = true;
        }, map);
      }      
  }
})();  // preserving the global namespace

var wb = new F1.WorldBank();
wb.init(<%= @country[:map].to_s %>);

function drawCharts(wb_project,projects_id) { wb_project.drawCharts(wb_project.map, projects_id)}
</script>